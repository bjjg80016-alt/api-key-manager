# 飞书密钥设置指南

## 📋 飞书API密钥类型

飞书提供了多种API密钥和配置，主要分为以下几类：

### 1. 飞书机器人Webhook
- **用途**: 消息推送通知
- **获取方式**: 飞书群组 -> 设置 -> 群机器人 -> 添加机器人 -> 自定义机器人
- **格式**: `https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx`

### 2. 飞书应用凭证
- **用途**: 调用飞书开放平台API
- **包含内容**:
  - App ID (应用凭证)
  - App Secret (应用密钥)
  - Tenant Key (租户密钥)

### 3. 飞书用户访问令牌
- **用途**: 用户身份验证
- **类型**: App Access Token, User Access Token

## 🚀 设置步骤

### 方法一：通过Web界面设置

1. **打开Web界面**
   ```bash
   # 启动Web服务
   python src/web_interface.py
   # 或打开静态HTML文件
   # 双击 web_interface.html
   ```

2. **添加飞书密钥**
   - 选择服务类型：`feishu` 或 `自定义`
   - 服务名称：`feishu`
   - API密钥：输入您的飞书Webhook URL或应用凭证

### 方法二：通过配置文件设置

编辑 `config/api_config.json`：

```json
{
  "api_keys": {
    "feishu": "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx",
    "feishu_app_id": "cli_xxxxxxxxxxxx",
    "feishu_app_secret": "xxxxxxxxxxxxxxxx"
  },
  "endpoints": {
    "feishu": "https://open.feishu.cn/open-apis"
  },
  "rates": {
    "feishu": {
      "rpm": 60,
      "tpm": 90000
    }
  }
}
```

### 方法三：通过环境变量设置

```bash
# Windows
set FEISHU_WEBHOOK=https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx
set FEISHU_APP_ID=cli_xxxxxxxxxxxx
set FEISHU_APP_SECRET=xxxxxxxxxxxxxxxx

# Linux/Mac
export FEISHU_WEBHOOK=https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx
export FEISHU_APP_ID=cli_xxxxxxxxxxxx
export FEISHU_APP_SECRET=xxxxxxxxxxxxxxxx
```

### 方法四：通过命令行工具设置

```bash
# 启动命令行工具
python src/api_key_manager.py

# 选择选项2：设置/更新API密钥
# 输入服务名称：feishu
# 输入API密钥：您的飞书Webhook URL
```

## 🔧 获取飞书密钥

### 获取飞书机器人Webhook

1. **创建群组机器人**
   - 打开飞书客户端
   - 进入目标群组
   - 点击群组设置
   - 选择"群机器人"
   - 点击"添加机器人"
   - 选择"自定义机器人"
   - 填写机器人名称和描述
   - 复制Webhook URL

2. **Webhook URL格式**
   ```
   https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxxxxxxxxxx
   ```

### 获取飞书应用凭证

1. **创建飞书应用**
   - 访问 [飞书开放平台](https://open.feishu.cn/)
   - 登录并进入开发者控制台
   - 创建企业自建应用
   - 获取 App ID 和 App Secret

2. **应用权限配置**
   - 在应用管理中设置所需权限
   - 如：消息推送、用户信息读取等

## 📝 使用示例

### 发送消息到飞书

```python
import requests
import json

# 从API密钥管理器获取飞书Webhook
webhook_url = manager.get_api_key('feishu')

# 发送消息
message = {
    "msg_type": "text",
    "content": {
        "text": "Hello from API Key Manager!"
    }
}

response = requests.post(webhook_url, json=message)
print(response.json())
```

### 使用飞书API

```python
import requests
import json

# 获取应用凭证
app_id = manager.get_api_key('feishu_app_id')
app_secret = manager.get_api_key('feishu_app_secret')

# 获取访问令牌
token_url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal"
token_data = {
    "app_id": app_id,
    "app_secret": app_secret
}

token_response = requests.post(token_url, json=token_data)
access_token = token_response.json().get('tenant_access_token')

# 使用访问令牌调用API
headers = {
    "Authorization": f"Bearer {access_token}",
    "Content-Type": "application/json"
}

# 发送消息
message_url = "https://open.feishu.cn/open-apis/im/v1/messages"
message_data = {
    "receive_id": "ou_xxxxxxxxxxxx",
    "content": json.dumps({
        "text": "Hello from API Key Manager!"
    }),
    "msg_type": "text"
}

message_response = requests.post(message_url, headers=headers, json=message_data)
print(message_response.json())
```

## 🔒 安全建议

1. **密钥保护**
   - 不要在代码中硬编码密钥
   - 使用环境变量或配置文件
   - 定期更换密钥

2. **权限控制**
   - 为应用设置最小必要权限
   - 定期审查应用权限
   - 监控API调用日志

3. **使用限制**
   - 遵守飞书API调用频率限制
   - 实现错误处理和重试机制
   - 监控API使用情况

## 🧪 测试飞书密钥

### 测试Webhook

```python
import requests

def test_feishu_webhook(webhook_url):
    """测试飞书Webhook"""
    test_message = {
        "msg_type": "text",
        "content": {
            "text": "🧪 飞书Webhook测试消息"
        }
    }
    
    try:
        response = requests.post(webhook_url, json=test_message)
        if response.status_code == 200:
            print("✅ 飞书Webhook测试成功")
            return True
        else:
            print(f"❌ 飞书Webhook测试失败: {response.status_code}")
            return False
    except Exception as e:
        print(f"❌ 飞书Webhook测试异常: {e}")
        return False
```

### 测试应用凭证

```python
import requests

def test_feishu_app(app_id, app_secret):
    """测试飞书应用凭证"""
    token_url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal"
    token_data = {
        "app_id": app_id,
        "app_secret": app_secret
    }
    
    try:
        response = requests.post(token_url, json=token_data)
        if response.status_code == 200:
            result = response.json()
            if result.get('code') == 0:
                print("✅ 飞书应用凭证测试成功")
                print(f"访问令牌: {result.get('tenant_access_token')}")
                return True
            else:
                print(f"❌ 飞书应用凭证测试失败: {result.get('msg')}")
                return False
        else:
            print(f"❌ 飞书应用凭证测试失败: {response.status_code}")
            return False
    except Exception as e:
        print(f"❌ 飞书应用凭证测试异常: {e}")
        return False
```

## 📚 相关资源

- [飞书开放平台文档](https://open.feishu.cn/document/)
- [飞书机器人开发指南](https://open.feishu.cn/document/ukTMukTMukTM/ucDO1UjL4gDO14CO4gTN)
- [飞书API参考](https://open.feishu.cn/document/ukTMukTMukTM/uYjNwUjL2YDM14iN2ATN)

---

现在您可以根据以上指南在API密钥管理工具中设置您的飞书密钥了！